# ShoppingListServer
https://github.com/danielroth1/ShoppingListApp


# Workflows




## REST
/users/authenticate - public route that accepts HTTP POST requests with username and password in the body. If the username and password are correct then a JWT authentication token is returned.

/users - secure route restricted to "Admin" users only, it accepts HTTP GET requests and returns a list of all users if the HTTP Authorization header contains a valid JWT token and the user is in the "Admin" role. If there is no auth token, the token is invalid or the user is not in the "Admin" role then a 401 Unauthorized response is returned.

/users/{id} - secure route restricted to authenticated users in any role, it accepts HTTP GET requests and returns the user record for the specified "id" parameter if authorization is successful. Note that "Admin" users can access all user records, while other roles (e.g. "User") can only access their own user record.

/users/register/{User} - POST 

/shopping/list/{ShoppingList} - POST

..


## SignalR
http://localhost:5678/shoppingserver/update

## Local Server
Setup:
- Edit appsettings.json
  the database server name and port is specified in appsettings.json. Change the path to localhost: "DbServerAddress": "server=localhost"
- change the url in Program.cs from "https://0.0.0.0:5678" to "http://0.0.0.0:5678" to disable https

## External Server with Docker
### Setup
- Edit appsettings.json
  Set "UseDocker": "True" in appsettings.json
- Certificates: put certificat files that were generated by certbot to the path specified in docker-compose.yml under services/volumes/source (default: /etc/letsencrypt/kestrel/)
  copy files from live folder in one the server is allowed to access:
```
sudo mkdir /etc/letsencrypt/kestrel
sudo cp /etc/letsencrypt/live/shopping-now.net/fullchain.pem /etc/letsencrypt/live/shopping-now.net/privkey.pem /etc/letsencrypt/kestrel
```

The client should be able to access the server under the registered certbot address which can be different from \<server-address\>, e.g.

\<server-address\> = vmd70876.contaboserver.net

\<certbot-address\> = shopping-now.net

You can test if everything worked, by running a HEAD request to /users/test:
```
curl -I https://<certbot-address>:5678/users/test
```

### Workflow

Make sure that appsettings.json has: "UseDocker": "True"
To work with docker, you can use the terminal.
Run the following command once to tell docker to deploy the docker image to the server instead of your machine:
```
export DOCKER_HOST=ssh://<user>@vmd70876.contaboserver.net
```
or on Windows
```
set DOCKER_HOST=ssh://<user>@vmd70876.contaboserver.net
```

See https://docs.docker.com/compose/production/#running-compose-on-a-single-server

Initially deploy both shoppinglistserver and database, by running the following command:
```
docker-compose up --build && docker-compose rm -fsv
```
The "&& docker-compose rm -fsv" makes sure to remove old images. Caution: This delets the database!

After every change in the server code, you only want to redeploy the shoppinglistserver and leave the database as is:
```
docker-compose up -d --no-deps --build shoppinglistserver
```
See https://docs.docker.com/compose/production/#deploying-changes

## External Server without Docker
- install mysql on your server and create a schema "shoppinglistserver" with a user "ShoppingListDBUser" and password "mysql-password-1234". This is specified in appsettings.json.
- in appsettings.json change the DBServerAddress to localhost: "DbServerAddress": "server=localhost"
- Certificates: put certificat files that were generated by certbot to the folder that is specified in appsettings.json: Kestrel/Certificates/Default/Path and Kestrel/Certificates/Default/KeyPath
  The server needs to be able to access the files which is not the case in the live folder. The path is relative to the server folder but you may change it to /etc/letsencrypt/kestrel and do the following:
```
sudo mkdir /etc/letsencrypt/kestrel
sudo cp /etc/letsencrypt/live/shopping-now.net/fullchain.pem /etc/letsencrypt/live/shopping-now.net/privkey.pem /etc/letsencrypt/kestrel
```

### Workflow
n/a

## General commands that you can ignore

### Docker
```bash
docker container run -d --name 'shopping-list' -p 5678:5678 sha256:6ecc3a5e1f501e6c2ea374176fd3e9f469eebae8ed6355818cd1393eb8fdd994
```

```
docker build -t shoppinglistserver .
docker run -d --name 'shoppinglistserver' -p 5678:5678 shoppinglistserver
```

### Setup the Database

- Install MySQL
-Â Create a schema as specified in appsettings.json
```
CREATE SCHEMA `shoppinglistserver` ;
``
- grant a user with name and password as specified in appsettings.json access to the schema 
- Initialize the database:

```
dotnet tool install --global dotnet-ef
```

If changes to the database were made, run
```
dotnet ef migrations add <your custom migration message, e.g. AddParameterOfSomeKind>
```

Migration is done automatically when starting the server so it's not necessary to run them automatically. If you opt to do anyways, you can do the following:
```
dotnet ef database update
```


### Start a single docker container
docker build -t shoppinglistserver .
docker run -d --rm --name 'shoppinglistserver' -p 5678:5678 shoppinglistserver

Start composed container
docker-compose up --build && docker-compose rm -fsv
docker-compose down


docker volume ls
docker volume inspect shoppinglistserver_dbdata
docker-compose up --build && docker-compose rm -fsv
docker-compose up -d --no-deps --build shoppinglistserver

Connect to database:
mysql -u ShoppingListDBUser -p shoppinglistserver

Database commands:
show tables;
show Users;
describe Users;
INSERT INTO Users VALUES(1, "bla@bla", "bla", "blalast", "username1", "passhash", "rolewhatever", "tokenhuh", "salty");

### Edit nginx

```
sudo nano /etc/nginx/sites-available/default
```

After changing the file:

```
sudo service nginx reload
```

We redirect the calls to https://shopping-now.net/shopping, https://shopping-now.net/users, and https://shopping-now.net/.well-known to the docker container.
This can be found in the nginx configuration file